<html>

<head>
	<script type="text/javascript" src="https://checkoutshopper-test.adyen.com/checkoutshopper/assets/js/sdk/checkoutSDK.1.2.0.min.js"></script>
</head>

<body>
	<h4>Checkout should appear below:</h4>
	<div id="spacer">
		<div class="checkout" id="checkout">
			<form class="clientForm" id="infoForm" action="http://localhost:8000/cgi-bin/checkout_requester.py">
				<div class="inputHolder">Amount: <input type="text" id="value" name="value" value="199"/><br></div>
				<div class="inputHolder">Currency: <input type="text" id="currency" name="currency" value="USD"/><br></div>
				<div class="inputHolder">CountryCode: <input type="text" id="countryCode" name="countryCode" value="US"/><br></div>
				<div class="inputHolder">ShopperLocale: <input type="text" id="shopperLocale" name="shopperLocale" value="en_GB"/><br></div>
				<div class="inputHolder">ShopperReference: <input type="text" id="shopperReference" name="shopperReference" value="localhostCheckout1"/><br></div>
				<div class="inputHolder">Channel: <input type="text" id="channel" name="channel" value="Web"/><br></div>
				<div class="inputHolder">MerchantAccount: <input type="text" id="merchantAccount" name="merchantAccount" value="ColinRood"/><br></div>
				<input type="button" id="checkoutBtn" value="Checkout"/>
			</form>
		</div>
	</div>
	<div id="verifyContainer" style="display: none;">
		<input type="button" id="verifyBtn" value="Verify Payment"/>
		<div id="verifyResult"></div>
	</div>
</body>

</html>

<script>

// Custom text
var translationObject = {
    payButton: {
        "en-US": "Subscribe",
        "nl-NL": "Meer opties"
    }
};

// Customer styling for card fields
var styleObject = {
    base: {
        color: '#00F',
        fontSize: '14px',
        lineHeight: '14px',
        fontSmoothing: 'antialiased'
    },
    error: {
        color: 'red'
    },
    placeholder: {
        color: '#d8d8d8'
    },
    validated: {
        color: 'green'
    }
};

// Styling for larger Checkout object
var sdkConfigObj = {
	base: {
		fontSize: '16px',
		background: "#68FFC1",
		outline: "2px black",
		color: "blue",
	},
	paymentMethods: {
		card: {
			sfStyles: styleObject
		}
	},
	context: "test",
	translations: translationObject
};

// Add eventListener to Checkout button
document.getElementById("checkoutBtn").addEventListener("click", openCheckout);

// Called on successful transaction
function setupVerify(pHookData) {

	console.log("setupVerify");
	console.log(pHookData);

	// Show verify container
	document.getElementById("verifyContainer").style.display = "block";

	// Set up verify call
	document.getElementById("verifyBtn").addEventListener("click", function() {

		// Disable verify button
		document.getElementById("verifyBtn").disabled = true;

		// Send data to server
		var url = "./cgi-bin/server_checkout.py";
		var postData = "endpoint=verify&payload=" + pHookData.payload;
		var headers = { "Content-Type": "application/x-www-form-urlencoded" };
		var method = "POST";

		AJAXPost(url + "?" + postData, headers, "POST", function() {
			// Display response
			document.getElementById("verifyResult").innerHTML = this.responseText;
		});
	});
}

// Handle response from setup call
setupCallback = function() {

	if (this.readyState == 4) {
		console.log(this);

		try {
			var data = JSON.parse(this.responseText);

			// Initialize checkout
			var checkout = chckt.checkout(data, '.checkout', sdkConfigObj);

			// Handle response from initiate call
			chckt.hooks.beforeComplete = function(pNode, pHookData, pData){
				setupVerify(pHookData);
				console.log(JSON.stringify(pData));
			}

			// Debug hooks
			chckt.hooks.beforeRedirect = function() {
				console.log("beforeRedirect");
			}
			chckt.hooks.beforePendingRedirect = function(selectedPMNode/*HTML Node*/, extraData/*Object*/) {
				console.log("beforePendingRedirect");
				selectedPMNode.style.opacity = '0.2';
				extraData.actionButton.style.opacity = '0.2';
				return false;
			};
		}
		catch (e) {
			console.log("error:");
			console.log(e);
			document.getElementById("checkout").innerHTML = this.responseText;
		}
	}
};

// Send request to server
function AJAXPost(path, headers, method, callback) {
	var request = new XMLHttpRequest();
	request.open(method || "POST", path, true);
	request.onreadystatechange = callback;

	for (var key in headers) {
		request.setRequestHeader(key, headers[key]);
	}

	request.send({});
};

function openCheckout() {
	var inputParams = document.querySelectorAll("input[type=text]");

	// Get request details from html form
	var formString = "";
	for (var param of inputParams) {
		formString = formString + param.name + "=" + param.value + "&";
	}
	formString = formString + "endpoint=setup";

	// Set parameters for request to server
	var url = "./cgi-bin/server_checkout.py";
	var headers = { "Content-Type": "application/x-www-form-urlencoded" };
	var method = "POST";

	// calls async javascript function to send to server
	AJAXPost(encodeURI(url + "?" + formString), headers, method, setupCallback);
}

</script>